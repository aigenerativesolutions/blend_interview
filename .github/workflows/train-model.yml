name: ğŸš€ MLOps Training Pipeline

on:
  push:
    branches: [ main ]
    paths:
      - 'marketing-ml-mvp/**'
      - 'data/**'
  workflow_dispatch:
    inputs:
      force_retrain:
        description: 'Force model retraining'
        required: false
        default: 'false'

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: us-central1
  TRAINING_FUNCTION_URL: ${{ secrets.TRAINING_FUNCTION_URL }}

jobs:
  trigger-training:
    runs-on: ubuntu-latest
    name: ğŸ¯ Trigger Model Training in GCP
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: ğŸ” Detect Changes
      id: changes
      run: |
        if git diff --name-only HEAD~1 HEAD | grep -E "(marketing-ml-mvp|data)" > /dev/null || [ "${{ github.event.inputs.force_retrain }}" == "true" ]; then
          echo "training_needed=true" >> $GITHUB_OUTPUT
          echo "ğŸš€ Changes detected in ML pipeline or data - Training needed"
        else
          echo "training_needed=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ No relevant changes detected - Skipping training"
        fi

    - name: ğŸ” Setup GCP Authentication
      if: steps.changes.outputs.training_needed == 'true'
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: â˜ï¸ Setup Google Cloud SDK
      if: steps.changes.outputs.training_needed == 'true'
      uses: google-github-actions/setup-gcloud@v1

    - name: ğŸ¯ Trigger Training in GCP
      if: steps.changes.outputs.training_needed == 'true'
      run: |
        echo "ğŸš€ Triggering model training in GCP..."
        
        # Get commit info for metadata
        COMMIT_SHA="${{ github.sha }}"
        COMMIT_MSG="${{ github.event.head_commit.message }}"
        AUTHOR="${{ github.event.head_commit.author.name }}"
        
        # Call Cloud Function to trigger training
        RESPONSE=$(curl -s -w "%{http_code}" -o response.json \
          -X POST "${{ env.TRAINING_FUNCTION_URL }}" \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer $(gcloud auth print-access-token)" \
          -d '{
            "trigger_source": "github_actions",
            "commit_sha": "'$COMMIT_SHA'",
            "commit_message": "'$COMMIT_MSG'",
            "author": "'$AUTHOR'",
            "branch": "'${{ github.ref_name }}'",
            "repository": "'${{ github.repository }}'"
          }')
        
        HTTP_CODE="${RESPONSE: -3}"
        
        if [ "$HTTP_CODE" -eq 200 ]; then
          echo "âœ… Training triggered successfully"
          cat response.json | jq .
          
          # Extract job_id for monitoring
          JOB_ID=$(cat response.json | jq -r '.job_id // empty')
          if [ ! -z "$JOB_ID" ]; then
            echo "ğŸ“Š Training Job ID: $JOB_ID"
            echo "job_id=$JOB_ID" >> $GITHUB_OUTPUT
          fi
        else
          echo "âŒ Failed to trigger training. HTTP Code: $HTTP_CODE"
          cat response.json
          exit 1
        fi
      id: trigger

    - name: ğŸ“Š Monitor Training Progress
      if: steps.changes.outputs.training_needed == 'true' && steps.trigger.outputs.job_id
      run: |
        JOB_ID="${{ steps.trigger.outputs.job_id }}"
        echo "ğŸ“Š Monitoring training job: $JOB_ID"
        
        # Monitor for up to 30 minutes
        for i in {1..60}; do
          echo "â³ Check #$i - Monitoring training progress..."
          
          STATUS_RESPONSE=$(curl -s \
            "${{ env.TRAINING_FUNCTION_URL }}/status?job_id=$JOB_ID" \
            -H "Authorization: Bearer $(gcloud auth print-access-token)")
          
          echo "$STATUS_RESPONSE" | jq .
          
          TRAINING_COMPLETED=$(echo "$STATUS_RESPONSE" | jq -r '.training_completed // false')
          INSTANCE_STATUS=$(echo "$STATUS_RESPONSE" | jq -r '.instance_status // "UNKNOWN"')
          
          if [ "$TRAINING_COMPLETED" == "true" ]; then
            echo "âœ… Training completed successfully!"
            echo "ğŸ‰ Model is now available in Cloud Storage"
            break
          elif [ "$INSTANCE_STATUS" == "TERMINATED" ] && [ "$TRAINING_COMPLETED" != "true" ]; then
            echo "âŒ Training instance terminated but training not completed"
            exit 1
          fi
          
          echo "ğŸ”„ Training in progress... (Status: $INSTANCE_STATUS)"
          sleep 30
        done

    - name: ğŸ“ Create Training Summary
      if: steps.changes.outputs.training_needed == 'true'
      run: |
        cat > training_summary.md << EOF
        # ğŸš€ MLOps Training Summary
        
        **Commit:** \`${{ github.sha }}\`  
        **Branch:** \`${{ github.ref_name }}\`  
        **Author:** ${{ github.event.head_commit.author.name }}  
        **Trigger:** GitHub Actions  
        **Timestamp:** $(date -u)
        
        ## Training Details
        - **Job ID:** ${{ steps.trigger.outputs.job_id || 'N/A' }}
        - **GCP Project:** ${{ env.GCP_PROJECT_ID }}
        - **Region:** ${{ env.GCP_REGION }}
        
        ## Changes Detected
        $(git diff --name-only HEAD~1 HEAD | grep -E "(marketing-ml-mvp|data)" || echo "Force retrain requested")
        
        ## Next Steps
        1. âœ… Model trained and uploaded to Cloud Storage
        2. ğŸ”„ Local Streamlit app can now sync the updated model
        3. ğŸ“Š Check \`gs://blend-mlops-models-${{ env.GCP_PROJECT_ID }}/models/latest/\`
        
        ---
        *Generated by GitHub Actions MLOps Pipeline*
        EOF
        
        echo "ğŸ“ Training Summary Created:"
        cat training_summary.md

    - name: ğŸ’¬ Comment on PR (if applicable)
      if: steps.changes.outputs.training_needed == 'true' && github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ğŸš€ **MLOps Training Triggered**
            
            A new model training has been initiated in GCP due to changes in this PR.
            
            **Training Job ID:** \`${{ steps.trigger.outputs.job_id || 'N/A' }}\`
            **GCP Project:** \`${{ env.GCP_PROJECT_ID }}\`
            
            The model will be available shortly at:
            \`gs://blend-mlops-models-${{ env.GCP_PROJECT_ID }}/models/latest/\`
            
            You can sync the updated model in your local Streamlit app! ğŸ¯`
          })

  notify-completion:
    runs-on: ubuntu-latest
    needs: trigger-training
    if: always()
    name: ğŸ“¢ Notify Results
    
    steps:
    - name: ğŸ“¢ Training Results
      run: |
        if [ "${{ needs.trigger-training.result }}" == "success" ]; then
          echo "ğŸ‰ MLOps Training Pipeline completed successfully!"
          echo "ğŸ“¦ Updated model is now available in Cloud Storage"
          echo "ğŸ”„ Local applications can sync the new model"
        else
          echo "âŒ MLOps Training Pipeline failed or was skipped"
          echo "ğŸ“ Check the logs for more details"
        fi